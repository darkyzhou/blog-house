---
title: 'æ¢ç©¶ rootless containers ä¸‹é€šè¿‡ systemd é…ç½® cgroup v2 '
date: 2021-12-07T06:56:59.095Z
category: 'Linux ç ”ç©¶æ—¥å¿—'
tags:
  - å®¹å™¨æŠ€æœ¯
  - runc
  - systemd
  - cgroup
  - go
excerpt: æœ¬æ–‡å°†ä»‹ç»å¦‚ä½•åœ¨ä»¥ä¸€ä¸ªæ™®é€šç”¨æˆ·çš„æƒé™åˆ›å»ºä½¿ç”¨ Linux å®¹å™¨çš„æƒ…å†µä¸‹ï¼Œé€šè¿‡ systemd é…ç½® cgroup v2ã€‚
---

### å‰è¨€

ç¬”è€…åœ¨ä¸Šä¸€ç¯‡åšæ–‡[ã€Šæ¢ç´¢ Rootless Containersï¼šåº”ç”¨äº OJ çš„ä¸‹ä¸€ä»£æŠ€æœ¯ã€‹](https://darkyzhou.net/articles/rootless-containers-oj)ä¸­æåˆ°ï¼Œæˆ‘ä»¬ç°åœ¨å·²ç»å¯ä»¥é€šè¿‡ umociã€runc è¿™æ ·çš„å·¥å…·ä»¥ä¸€ä¸ªæ™®é€šç”¨æˆ·çš„æƒé™åˆ›å»ºå¹¶è¿è¡Œå®¹å™¨ï¼Œè¿™ç§æŠ€æœ¯è¢«ç§°ä¸º Rootless Containersã€‚æˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨ seccomp å’Œ rlimit å¯¹å®¹å™¨è¿›ç¨‹åšå‡ºä¸€å®šç¨‹åº¦çš„é™åˆ¶ï¼Œå¦‚é™åˆ¶éƒ¨åˆ†ç³»ç»Ÿè°ƒç”¨ã€é™åˆ¶æ‰“å¼€çš„æ–‡ä»¶æ•°é‡ç­‰ã€‚

ä¸è¿‡ï¼Œæˆ‘ä»¬è¿˜æ²¡æœ‰æ‰«æ¸… Rootless Containers åº”ç”¨äº OJ è¿™ä¸€è¯¾é¢˜çš„æœ€åä¸€ä¸ªéšœç¢ï¼šcgroupã€‚å®¹å™¨æŠ€æœ¯éœ€è¦çš„è®¸å¤šé‡è¦çš„é™åˆ¶åŠŸèƒ½å…¶å®éƒ½ç”± cgroup æä¾›ï¼Œä¾‹å¦‚ cpusetã€io é™åˆ¶ç­‰ã€‚å¹¶ä¸”ï¼Œcgroup èƒ½å¤Ÿæä¾› oom kill åŠŸèƒ½ï¼Œåœæ­¢è¶…å‡ºå†…å­˜é™åˆ¶çš„è¿›ç¨‹ï¼›cgroup è¿˜èƒ½ç»Ÿè®¡è¿›ç¨‹å ç”¨çš„ cpuã€å†…å­˜ç­‰ä¿¡æ¯ã€‚è¿™äº›å¯¹äº OJ è€Œè¨€éƒ½æ˜¯ç›¸å½“é‡è¦çš„åŠŸèƒ½ã€‚

æœ¬æ–‡å°†ä»‹ç»å¦‚ä½•åœ¨ä»¥ä¸€ä¸ªæ™®é€šç”¨æˆ·çš„æƒé™åˆ›å»ºä½¿ç”¨ Linux å®¹å™¨çš„æƒ…å†µä¸‹ï¼Œé€šè¿‡ systemd é…ç½® cgroup v2ã€‚

### cgroup v1

æˆªè‡³ 2023 å¹´ 5 æœˆï¼Œå¤§å¤šæ•°çš„æ–°çš„ Linux å‘è¡Œç‰ˆå·²ç»ä¸å†é»˜è®¤å¼€å¯ cgroup v1 äº†ï¼Œç¬”è€…è®¤ä¸ºå®ƒå·²ç»æ˜¯ä¸€ä¸ªè¿‡æ—¶çš„æŠ€æœ¯äº†ï¼Œç°æœ‰çš„ç¨‹åºåº”å½“å°½å¿«è¿ç§»è‡³ cgroup v2ã€‚ä»¥ä¸‹æ˜¯ç¬”è€…æ€»ç»“çš„ä¸€äº› cgroup v1 çš„ç¼ºé™·ã€‚

#### éœ€è¦ root æƒé™

cgroup v1 èµ·åˆæ˜¯æä¾›ç»™ root ä½¿ç”¨çš„ï¼Œæ™®é€šç”¨æˆ·ä½¿ç”¨ cgroup v1 éœ€è¦ç»è¿‡æŸç§å§”æ‰˜æœºåˆ¶ï¼Œå³ç”±ä¸€ä¸ªæ‹¥æœ‰ root æƒé™çš„æœåŠ¡å»ä»£æ›¿æ™®é€šç”¨æˆ·å’Œ cgroup è¿›è¡Œäº¤äº’ï¼Œ[ä½†è¿™å­˜åœ¨å®‰å…¨é£é™©](https://rootlesscontaine.rs/how-it-works/cgroups/#v1)ï¼Œæ‰€ä»¥**åœ¨ Rootless Containers çš„å®šä¹‰é‡Œä¸åŒ…å« cgroup v1ï¼Œåªèƒ½ä½¿ç”¨ cgroup v2**ã€‚

å¦å¤–ï¼Œå¦‚æœè·‘åœ¨ Kubernetes é‡Œçš„åº”ç”¨è¦ä½¿ç”¨ cgroup v1ï¼Œåˆ™ä¸€èˆ¬éœ€è¦åœ¨ Pod é‡ŒæŒ‚è½½ cgroup æ–‡ä»¶å¤¹ï¼Œè¿˜è¦ç»™å®¹å™¨èµ‹äºˆè¶³å¤Ÿçš„æƒé™ï¼Œè¿™æ ·æ¥çœ‹æ˜¯éå¸¸ä¸å®‰å…¨çš„ã€‚

#### å®ç°ä¸ç»Ÿä¸€

cgroup v1 å› ä¸ºå„ç§å†å²åŸå› ï¼Œç›®å‰çš„å®ç°å¾ˆä¸ç»Ÿä¸€ï¼Œå„ç§ controller çš„å¼€å‘å·¥ä½œæ²¡æœ‰å¾ˆå¥½åœ°åè°ƒï¼Œå¯¼è‡´ controller ä¹‹é—´å­˜åœ¨è®¸å¤šä¸ä¸€è‡´æ€§ã€‚åŒæ—¶ï¼Œä¹Ÿå› ä¸ºè¿™ç§ä¸ç»Ÿä¸€çš„å®ç°ï¼Œç”¨æˆ·ä½¿ç”¨ cgroup v1 ä¹Ÿå¾ˆéº»çƒ¦ï¼Œä¾‹å¦‚è¦é™åˆ¶æŸä¸ªè¿›ç¨‹çš„ cpuã€å†…å­˜ã€io ä½¿ç”¨ï¼Œéœ€è¦åˆ†åˆ«åˆ°ä¸‰ä¸ª controller çš„ç›®å½•ä¸‹è¿›è¡Œäº¤äº’ã€‚

å› æ­¤ï¼Œcgroup v2 å°±è¢«æäº†å‡ºæ¥ï¼Œæ‹¥æœ‰æ›´ç»Ÿä¸€ã€æ–¹ä¾¿ä½¿ç”¨çš„ APIã€‚è™½ç„¶å› ä¸ºå…¼å®¹æ€§è€ƒè™‘ cgroup v1 å¯èƒ½ä¼šä¸€ç›´ç•™åœ¨å†…æ ¸é‡Œï¼Œä½† **cgroup v2 å·²ç»å¼€å§‹åœ¨å„å¤§å‘è¡Œç‰ˆä¸­å–ä»£äº† cgroup v1 çš„åœ°ä½**ã€‚ä¾‹å¦‚ï¼šUbuntu ä»æœ€è¿‘çš„ 21.10 ç‰ˆæœ¬å¼€å§‹å°±é»˜è®¤åªå¼€å¯ cgroup v2ï¼Œç¦ç”¨ cgroup v1ã€‚

#### å¤æ‚æ€§

åœ¨ cgroup v1 ä¸­ï¼Œä¸€ä¸ªè¿›ç¨‹çš„ä¸åŒçº¿ç¨‹å¯ä»¥åˆ†åˆ«å±äºä¸åŒçš„ cgroupï¼Œå¾ˆå¤šäººè®¤ä¸ºè¿™ä¸ªè®¾è®¡æ²¡ä»€ä¹ˆç”¨ï¼Œè¿˜ç™½ç™½æ·»åŠ äº†å¤æ‚æ€§ã€‚æ›´ç³Ÿç³•çš„æ˜¯ï¼Œè¿™ç»™ cgroup v1 è‡ªèº«æŒ–äº†è®¸å¤šå‘ï¼Œæ¯”å¦‚ memory controllerï¼ˆå³ç®¡ç†å†…å­˜é™åˆ¶çš„ controllerï¼‰ä¸èƒ½æ­£å¸¸å·¥ä½œäº†ï¼Œå› ä¸ºä¸åŒçº¿ç¨‹å±äºä¸åŒ cgroupï¼Œåˆ†å±ä¸åŒ memory controller ç®¡è¾–ï¼Œä½†æ˜¯å®ƒä»¬å´åˆå…±äº«åŒä¸€ä¸ªè¿›ç¨‹çš„å†…å­˜ç©ºé—´ï¼Œè¿™ç§æƒ…å†µä¸‹ memory controller åˆè¯¥æ€ä¹ˆå·¥ä½œå‘¢ï¼Ÿ

åœ¨ cgroup v2 é‡Œäººä»¬å»æ‰äº†è¿™ç§è®¾è®¡ã€‚ä¸€ä¸ªè¿›ç¨‹çš„æ‰€æœ‰çº¿ç¨‹åªèƒ½å±äºåŒä¸€ä¸ª cgroupï¼ˆè™½ç„¶åæ¥åˆåœ¨ threaded mode é‡ŒåŠ äº†å›æ¥ï¼Œä¸è¿‡åŠ ä¸Šäº†å¾ˆå¤šé™åˆ¶ï¼‰ã€‚åœ¨ç¬”è€…çœ‹æ¥ï¼Œå½“å‰æ–°å¼€å‘çš„åº”ç”¨å·²ç»æ²¡æœ‰å¿…è¦è€ƒè™‘ cgroup v1 äº†ï¼Œcgroup v2 æ‹¥æœ‰æ›´åŠ ç»Ÿä¸€ã€æ˜“ç”¨ã€ç¬¦åˆç›´è§‰çš„ API è®¾è®¡ï¼Œå¹¶ä¸”å·²ç»å¼€å§‹å–ä»£ cgroup v1ã€‚

### cgroup v2

cgroup v2 å’Œ cgroup v1 çš„å…·ä½“å·®åˆ«è¯·è¯»è€…è‡ªè¡ŒæŸ¥é˜…èµ„æ–™ã€‚æ ¹æ® [man7 æ–‡æ¡£](https://man7.org/linux/man-pages/man7/cgroups.7.html)ï¼Œcgroup v2 æ¸…æ¥šåœ°å®šä¹‰äº†å¦‚ä½•å‘æ™®é€šç”¨æˆ·æä¾› cgroup v2 äº¤äº’èƒ½åŠ›ï¼Œç²—ç•¥æ¥è¯´å°±æ˜¯ï¼š

1. åˆ›å»ºä¸€ä¸ªå­æ–‡ä»¶å¤¹ä½œä¸º sub-cgroup

2. åœ¨è¿™ä¸ªå­æ–‡ä»¶å¤¹çš„çˆ¶æ–‡ä»¶å¤¹ï¼ˆä¹Ÿæ˜¯ä¸€ä¸ª cgroupï¼‰é‡Œï¼Œä¿®æ”¹ `cgroup.subtree_control` æ–‡ä»¶æ¥æ§åˆ¶ sub-cgroup èƒ½ä½¿ç”¨çš„ controller ç§ç±»ã€‚

3. é€šè¿‡ chown ç»™æ™®é€šç”¨æˆ·æ¥è®©ä»–èƒ½å¤Ÿä½¿ç”¨è¿™ä¸ª sub-cgroupã€‚

åœ¨ç›®å‰çš„è®¸å¤šå‘è¡Œç‰ˆä¸­ï¼Œ`/sys/fs/cgroup` å·²ç»è‡ªåŠ¨è¢« systemd æŒ‚è½½ã€‚ä½† systemd åšçš„æ—¶æœŸå¯ä¸ä»…ä»…æ˜¯å¸®ä½  `mount -t cgroup2` è¿™ä¹ˆç®€å•ï¼Œå®ƒåšçš„äº‹æƒ…æ˜¯è®©è‡ªå·±â€œæ‹¥æœ‰â€è¿™ä¸ª cgroup v2ã€‚æ¢å¥è¯è¯´ï¼Œä»»ä½•æƒ³è¦ä½¿ç”¨ cgroup v2 çš„è¿›ç¨‹éƒ½éœ€è¦ç»è¿‡ systemd çš„ç®¡ç†ã€‚

ä½ ä¸èƒ½åœ¨ `/sys/fs/cgroup` é‡Œç›´æ¥ä½¿ç”¨ä¸Šé¢ man7 æåˆ°çš„æ–¹æ³•ï¼Œå› ä¸º [systemd çš„æ–‡æ¡£](https://systemd.io/CGROUP_DELEGATION/)è¿™ä¹ˆè­¦å‘Šä½ ï¼š

> Specifically: ğŸ”¥ donâ€™t create your own cgroups **<u>below the root cgroup</u>** ğŸ”¥. Thatâ€™s owned by systemd, and you will step on systemdâ€™s toes if you ignore that, and systemd will step on yours. Get your own delegated sub-tree, you may create as many cgroups there as you like. Seriously, if you create cgroups directly in the cgroup root, then all you do is ask for trouble.

æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸‹åˆ—æ–¹æ³•è®© systemd ç»™æ™®é€šç”¨æˆ·åˆ›å»ºä¸€ä¸ª sub-cgroupï¼š

```
$ sudo mkdir -p /etc/systemd/system/user@.service.d
$ cat <<EOF | sudo tee /etc/systemd/system/user@.service.d/delegate.conf
[Service]
Delegate=cpu cpuset io memory pids
EOF
$ sudo systemctl daemon-reload
```

è¿™æ ·ï¼Œsystemd å°±ä¼šåˆ›å»ºä¸€ä¸ªç±»ä¼¼äº `/sys/fs/cgroup/user.slice/user-1000.slice/user@1000.service` çš„æ–‡ä»¶å¤¹ï¼Œè¿™ä¸ªæ–‡ä»¶å¤¹çš„æ‰€æœ‰è€…æ˜¯æ™®é€šç”¨æˆ·ï¼Œå¯¹åº”ç€ä¸€ä¸ªå®Œå…¨ç”±æ™®é€šç”¨æˆ·æ§åˆ¶çš„ cgroupã€‚æˆ‘ä»¬å¯ä»¥åœ¨è¿™ä¸ªæ–‡ä»¶å¤¹é‡Œéšæ„åˆ›å»ºæ–°çš„æ–‡ä»¶å¤¹ï¼ˆä¹Ÿå°±æ˜¯ sub-cgroupï¼‰æ¥é™åˆ¶è¿›ç¨‹ã€‚å¯ä»¥é€šè¿‡è¯»å– `memory.stat` å’Œ `cpu.stat` æ–‡ä»¶æ¥è·å¾—è¿›ç¨‹ä½¿ç”¨çš„å†…å­˜å’Œ cpu ä¿¡æ¯ã€‚

ä¸è¿‡ï¼Œå› ä¸ºä¸çŸ¥é“ systemd å…·ä½“ç»™å½“å‰ç”¨æˆ·åˆ†é…äº†å“ªä¸ªæ–‡ä»¶å¤¹ï¼Œæ‰€ä»¥ä¸€èˆ¬æƒ…å†µä¸‹åº”ç”¨åº”è¯¥è°ƒç”¨ DBus æ¥åˆ›å»ºä¸€ä¸ª transient unitï¼Œå‘Šè¯‰ systemd åœ¨å½“å‰ç”¨æˆ·çš„ cgroup é‡Œç»™åº”ç”¨å¼€ä¸€ä¸ªæ–°çš„ sub-cgroupã€‚åœ¨ transient unit é‡Œæˆ‘ä»¬éœ€è¦æŒ‡å®š `[Delegate]` å‚æ•°æ‰èƒ½å‘Šè¯‰ systemd è¿™ä¸ª sub-cgroup äº¤ç»™æˆ‘ä»¬çš„åº”ç”¨è‡ªå·±ç®¡ç†ï¼Œå…·ä½“å¯è§[æ–‡æ¡£](https://systemd.io/CGROUP_DELEGATION/)ã€‚

### runc ä¸ libcontainer

ç¬”è€…å·²ç»åœ¨å‰ä¸€ç¯‡æ–‡ç« [ã€Šæ¢ç´¢ Rootless Containersï¼šåº”ç”¨äº OJ çš„ä¸‹ä¸€ä»£æŠ€æœ¯ã€‹](https://darkyzhou.net/articles/rootless-containers-oj)ä¸­ä»‹ç»äº†å¦‚ä½•ä½¿ç”¨ runc åˆ›å»º rootless containerã€‚ä½†æ²¡æœ‰ä»‹ç» cgroup v2 çš„é…ç½®ã€‚æ¥ä¸‹æ¥ç¬”è€…ç»“åˆä¸Šé¢å¯¹ cgroup v2 çš„è®¨è®ºï¼Œä»‹ç»å¦‚ä½•è®© runc å¾—ä»¥åˆ©ç”¨ cgroupã€‚

> æœ‰ä¸€ç‚¹éœ€è¦æå‰è¯´æ˜ï¼š**åœ¨è¿™ç§åœºæ™¯ä¸‹ï¼Œå’Œ runc äº¤äº’çš„æœ€å¥½æ–¹æ³•åº”è¯¥æ˜¯åœ¨ go ç¨‹åºé‡Œè¿›è¡Œè°ƒç”¨ï¼Œè€Œä¸æ˜¯é€šè¿‡å®¹å™¨çš„ json æ–‡ä»¶**ã€‚å› ä¸º runc å’Œå®ƒå†…éƒ¨çš„ libcontainer æœ‰å¾ˆå¤šéå¸¸å®ç”¨çš„ API å¹¶æ²¡æœ‰é€šè¿‡ json æ¥å£æš´éœ²ã€‚

runc çš„ libcontainer æä¾›äº†ä¸€ä¸ª [`systemdManager`](https://github.com/opencontainers/runc/blob/268511680f4a72b4a0595497a37e4d6a7da0215c/libcontainer/cgroups/systemd/v2.go)ï¼Œæ”¯æŒåœ¨ rootless æƒ…æ™¯ä¸‹åˆ©ç”¨ systemd åˆ›å»º cgroup v2 æ–‡ä»¶å¤¹ã€‚ä½†æ˜¯å®ƒæœ‰ä¸€ä¸ªç¼ºé™·ï¼šå½“å®¹å™¨è¿›ç¨‹é€€å‡ºä¹‹åï¼Œsystemd ä¼šè‡ªåŠ¨æ¸…ç†åˆ›å»ºå‡ºæ¥çš„ cgroupï¼Œå¯¼è‡´æˆ‘ä»¬çš„åº”ç”¨æ— æ³•æ”¶é›† cpuã€å†…å­˜å ç”¨ç­‰ä¿¡æ¯ã€‚

ä» [runc æºç ](https://github.com/opencontainers/runc/blob/HEAD/libcontainer/cgroups/systemd/v2.go) ä¸­å¯ä»¥çœ‹åˆ°ï¼Œå®ƒæ˜¯é€šè¿‡ DBus åˆ›å»ºäº†ä¸€ä¸ª transient scope æ¥è®© systemd ä¸ºåˆ›å»ºçš„å®¹å™¨è¿›ç¨‹å¼€ä¸€ä¸ª cgroupã€‚é—®é¢˜çš„å…³é”®åœ¨äºï¼Œä¾æ® [systemd å¯¹ transient scope çš„å®šä¹‰](https://systemd.io/CGROUP_DELEGATION/)ï¼š

> The .scope unit type. This is very similar to .service. The main difference: the processes the units of this type encapsulate are forked off by some unrelated manager process, and that manager asked systemd to expose them as a unit.

Transient scope ä»£è¡¨çš„å®¹å™¨è¿›ç¨‹æ˜¯ä¸€ç§ç”±å…¶ä»–è¿›ç¨‹ï¼ˆä¹Ÿå°±æ˜¯è°ƒç”¨ runc çš„æˆ‘ä»¬çš„åº”ç”¨ï¼‰åˆ›å»ºçš„å­è¿›ç¨‹ï¼Œå› æ­¤åœ¨å­è¿›ç¨‹é€€å‡ºä¹‹å**åº”è¯¥è‡ªåŠ¨æ¸…ç†æ‰**ã€‚å¯¹äº runc æœ¬èº«æ¥è¯´è¿™æ²¡æœ‰ä»€ä¹ˆé—®é¢˜ï¼Œä½†æ˜¯å¯¹äºæˆ‘ä»¬çš„åº”ç”¨æ¥è¯´ï¼Œè‡ªåŠ¨æ¸…ç†å°±æ„å‘³ç€æ— æ³•çŸ¥é“å®¹å™¨è¿è¡Œç»“æŸä¹‹åå®ƒåˆ°åº•å ç”¨äº†å¤šå°‘ cpu æ—¶é—´ã€å ç”¨äº†å¤šå°‘å†…å­˜ç­‰ä¿¡æ¯ã€‚è€Œä¸” runc çš„ `systemdManager` çš„å‚æ•°éå¸¸ä¸äººæ€§åŒ–ã€‚å®ƒä¼šåœ¨é…ç½® cgroup å¤±è´¥ä¹‹åé»˜é»˜åœ°æ‰“å°ä¸€è¡Œ warning ç„¶åç»§ç»­è¿è¡Œå®¹å™¨ï¼Œå¿½ç•¥ç”¨æˆ·ç»™å®šçš„ cgroup é…ç½®å‚æ•°ã€‚åœ¨ OJ çš„åœºæ™¯ä¸‹è¿™ä¸ªè¡Œä¸ºæ˜¯æ— æ³•æ¥å—çš„ï¼Œä¸èƒ½å‡ºç°æœ‰äº›ç”¨æˆ·çš„æäº¤çš„ä»£ç å¯ä»¥å—åˆ°é™åˆ¶è€Œæœ‰äº›ä¸å—é™åˆ¶çš„æƒ…å†µã€‚

å› æ­¤ï¼Œæˆ‘ä»¬åªå¥½ä½¿ç”¨ runc ä¸º rootless æ¨¡å¼æä¾›çš„å¦ä¸€ä¸ªå®ç°ï¼š[`fsManager`](https://github.com/opencontainers/runc/blob/268511680f4a72b4a0595497a37e4d6a7da0215c/libcontainer/cgroups/fs2/fs2.go)ã€‚è¿™ä¸ªå®ç°åšçš„äº‹æƒ…å°±æ˜¯ç›´æ¥è¯»å†™ç»™å®šçš„ cgroup æ–‡ä»¶å¤¹æ¥ä¸ºå®¹å™¨åˆå§‹åŒ–ç›¸å…³è®¾å®šï¼Œè€Œä¸”å®ƒä¸ä¼šåœ¨å®¹å™¨åœæ­¢ä¹‹åå°±é©¬ä¸Šåˆ æ‰æ–‡ä»¶å¤¹ã€‚è‡³äºå¦‚ä½•ç»™ runc æä¾› cgroup æ–‡ä»¶å¤¹åˆ™éœ€è¦æˆ‘ä»¬å¦è¾Ÿè¹Šå¾„äº†ã€‚

> å…¶å® runc è°ƒç”¨ systemd çš„å®ç°æœ€ç»ˆä¹Ÿæ˜¯ç”¨åˆ°äº†è¿™ä¸ª `fsManager`ã€‚å®ƒæ˜¯å…ˆè°ƒç”¨ systemd ç”³è¯·åˆ°ä¸€ä¸ª cgroupï¼Œå†è¾“å…¥ç»™è¿™ä¸ª `fsManager` æ¥åˆå§‹åŒ–å„ç§è®¾å®šã€‚

### å°è¯•

ç»è¿‡ä¸Šé¢çš„ç ”ç©¶ï¼Œç¬”è€…é©¬ä¸Šæƒ³åˆ°äº†ä¸€ä¸ªè§£å†³çš„åŠæ³•ï¼šåº”ç”¨é¦–å…ˆè°ƒç”¨ DBusï¼Œç»™è‡ªå·±çš„è¿›ç¨‹åˆ›å»ºä¸€ä¸ª transient scopeï¼Œè¿™æ ·å°±èƒ½å¼€ä¸€ä¸ª sub-cgroup æ–‡ä»¶å¤¹ç»™ runc ä½¿ç”¨äº†ã€‚

> è°ƒç”¨ DBus çš„ç›¸å…³ä»£ç å¯ä»¥å‚è€ƒ [runc çš„æºç ](https://github.com/opencontainers/runc/blob/HEAD/libcontainer/cgroups/systemd/v2.go)ã€‚å¯¹äº Debian ç³»å‘è¡Œç‰ˆï¼Œéœ€è¦å®‰è£… `dbus-user-session` åŒ…æ¥å¼€å¯ç›¸å…³åŠŸèƒ½ã€‚

ç„¶è€Œï¼Œç¬”è€…è¯•äº†ä¸€ä¸‹å¹¶ä¸èƒ½æˆåŠŸï¼Œè¯¦ç»†çš„åŸå› å¯ä»¥è§[æˆ‘å‘çš„ issue](https://github.com/opencontainers/runc/issues/3255#issuecomment-967780774)ã€‚ç®€å•æ¥è¯´ï¼Œrunc ä¸ºäº†å°è¯•å¼€å¯æ‰€æœ‰çš„ cgroup controllerï¼Œä¼šè¿­ä»£åœ°å‘è¾“å…¥ç»™ runc çš„ cgroup çš„æ‰€æœ‰ç¥–å…ˆ cgroup çš„ `cgroup.subtree_control` é‡Œå†™å…¥æ‰€æœ‰ç±»å‹çš„ controllerã€‚

ä½†æ˜¯ cgroup v2 é‡Œæœ‰ä¸€æ¡å‘çˆ¹çš„è®¾å®šï¼š

> A domain cgroup is turned into a threaded domain when one of its child
> cgroup becomes threaded or threaded controllers are enabled in the
> "cgroup.subtree_control" file while there are processes in the cgroup.
> A threaded domain reverts to a normal domain when the conditions
> clear.

ç®€å•æ¥è¯´ï¼Œcgroup v2 çš„æ ‘å½¢ç»“æ„ä¸­åªæœ‰å¶å­èŠ‚ç‚¹æ‰èƒ½åŒ…å«è¿›ç¨‹ï¼Œè€Œå†…éƒ¨èŠ‚ç‚¹ä¸èƒ½åŒ…å«è¿›ç¨‹ã€‚è¿™æœ‰ä¸€ä¸ªä¾‹å¤–ï¼šthreaded mode çš„å†…éƒ¨èŠ‚ç‚¹å¯ä»¥åŒ…å«è¿›ç¨‹ï¼ˆæˆ–è€…è¯´çº¿ç¨‹ï¼Œè§ `cgroup.threads`ï¼‰ï¼Œä½†å®ƒçš„å¶å­èŠ‚ç‚¹ä¹Ÿåªèƒ½æ˜¯ threaded modeã€‚æ³¨æ„ threaded mode ä»å¯ä½¿ç”¨ cpu controllerï¼Œä½†æ— æ³•ä½¿ç”¨ memory controller ç­‰ã€‚è¿™ä¸ªæ¨¡å¼ä¸‹çš„ cgroup æ§åˆ¶çš„æœ€å°å•ä½ä»è¿›ç¨‹å˜æˆäº†çº¿ç¨‹ï¼Œæ‰€ä»¥ memory controller å’Œ io controller ä¹Ÿæ— æ³•ä½¿ç”¨äº†ï¼ˆåŸå› æ¯”è¾ƒæ˜äº†ï¼šæ€ä¹ˆå¯ä»¥é™åˆ¶çº¿ç¨‹çš„å†…å­˜å ç”¨å‘¢ï¼Ÿï¼‰ã€‚å› æ­¤ï¼Œç¬”è€…çš„ç›®çš„ä¸èƒ½å®Œæˆäº†ï¼Œä¸èƒ½æ‹¿åˆ°å†…å­˜å ç”¨æ•°æ®çš„ OJ è¿˜æœ‰ä»€ä¹ˆæ„ä¹‰å‘¢ã€‚

å¦‚æœä¸€ä¸ª cgroup å·²ç»åŒ…å«äº†ä¸€ä¸ªè¿›ç¨‹ï¼ˆæ¯”å¦‚ä¸Šé¢ç¬”è€…åº”ç”¨çš„è¿›ç¨‹ï¼‰ï¼Œé‚£ä¹ˆ runc åœ¨å¼€å¯ cpu controller çš„æ—¶å€™ä¼šè¢« cgroup ä»¥ä¸ºæ˜¯è¦å¼€å¯ threaded modeï¼Œå¯¼è‡´ç¬”è€…åº”ç”¨è‡ªå·±çš„ cgroup å’Œä¼ ç»™ runc çš„ sub-cgroup å…¨éƒ¨å˜æˆ threaded modeã€‚äº‹å®ä¸Šè¿™å°±æ˜¯ [manpage](https://www.man7.org/linux/man-pages/man7/cgroups.7.html) ä¸­æåˆ°çš„ â€œThe second way of creating a threaded subtreeâ€ã€‚

### è§£å†³æ–¹æ¡ˆ

ç»è¿‡åå¤é˜…è¯» systemd å’Œ cgroup çš„ç›¸å…³æ–‡æ¡£ï¼Œæˆ‘å‘ systemd ä»“åº“å‘è¡¨äº†ä¸€ä¸ª [issue](https://github.com/systemd/systemd/issues/26311) å¯»æ±‚å¸®åŠ©å¹¶æå‡ºäº†ä¸€äº›è§è§£ã€‚åœ¨ç»´æŠ¤è€… Lennart Poettering çš„å¸®åŠ©ä¸‹æˆ‘å¾—åˆ°äº†ä¸‹é¢çš„è§£å†³åŠæ³•ï¼š

1. åº”ç”¨è°ƒç”¨ DBusï¼Œä¸ºå½“å‰çš„åº”ç”¨è¿›ç¨‹åˆ›å»ºä¸€ä¸ª transient scopeã€‚systemd ä¿è¯åˆ›å»ºå‡ºæ¥çš„ cgroup å¯ä»¥è¢«å½“å‰ç”¨æˆ·ï¼ˆæ™®é€šç”¨æˆ·ï¼‰è¯»å†™ã€‚è¿™ä¸€æ­¥æ˜¯ä¸ºäº†ç¡®ä¿ runc åˆ›å»ºçš„å®¹å™¨è¿›ç¨‹ä¾ç„¶èƒ½å¤Ÿè¢«å½“å‰ç”¨æˆ·çš„ cgroup ç®¡è¾–ã€‚å¦åˆ™å®ƒé»˜è®¤ä¼šè¢« root cgroupï¼ˆä¹Ÿå°±æ˜¯ systemd ç›´æ¥ç®¡ç†çš„é‚£ä¸ªé¡¶å±‚ cgroupï¼‰ç®¡è¾–ï¼Œå½“å‰ç”¨æˆ·ï¼ˆæ™®é€šç”¨æˆ·ï¼‰æ˜¯æ²¡æœ‰æƒé™çš„ã€‚
2. åœ¨åˆ›å»ºçš„çˆ¶ cgroup ä¸­å»ºç«‹ä¸€ä¸ªå­ cgroupï¼Œç§°ä¸º `app.scope`ï¼ˆæ­¤å‘½åé£æ ¼ä¸æ˜¯å¿…è¦çš„ï¼Œä½†ç¬¦åˆ systemd çš„è¯­ä¹‰ï¼‰ã€‚å‘åè€…çš„ `cgroup.procs` ä¸­å†™å…¥å½“å‰è¿›ç¨‹çš„ IDï¼Œå³å°†å½“å‰è¿›ç¨‹ç§»åˆ° `app.scope` ä¸­ã€‚
3. åœ¨åˆ›å»ºçš„çˆ¶ cgroup ä¸­å»ºç«‹ä¸€ä¸ªå­ cgroupï¼Œç§°ä¸º `container.slice`ï¼ˆæ­¤å‘½åé£æ ¼ä¸æ˜¯å¿…è¦çš„ï¼Œä½†ç¬¦åˆ systemd çš„è¯­ä¹‰ï¼‰ã€‚å°†è¿™ä¸ª cgroup è·¯å¾„ä¼ ç»™ runcï¼Œå¹¶å¯ç”¨å®ƒçš„ `fsManager`ã€‚æ­¤æ—¶ runc ä¼šå°è¯•åœ¨ `container.slice` ä¸­å»ºç«‹å­ cgroupï¼Œå¹¶å°†åˆ›å»ºçš„å®¹å™¨æ”¾ç½®åœ¨å…¶ä¸­è¿›è¡Œç®¡ç†ã€‚
4. æˆ‘ä»¬å·²ç»å¯ä»¥åœ¨å®¹å™¨ç»“æŸä¹‹åè°ƒç”¨ runc ç›¸å…³çš„ API æ¥è·å¾— cgroup çš„ç›¸å…³ä¿¡æ¯ï¼Œæ¯”å¦‚ cpu æ—¶é—´ï¼ˆåŒ…æ‹¬ç”¨æˆ·æ€æ—¶é—´ã€å†…æ ¸æ€æ—¶é—´ï¼‰ã€å†…å­˜å ç”¨ï¼ˆåŒ…æ‹¬ swapï¼‰ç­‰ã€‚

> ä¸Šé¢çœç•¥äº†åœ¨çˆ¶ cgroup ä¸­é…ç½® `cgroup.subtree_control` å’Œåœ¨å­ cgroup ä¸­å¼€å¯ç›¸å…³ controllerã€‚

ç»è¿‡æµ‹è¯•ï¼Œä¸Šè¿°æ–¹æ³•æˆåŠŸè§£å†³äº†é—®é¢˜ã€‚ç¬”è€…çš„åº”ç”¨ç°åœ¨å¯ä»¥ä»¥ä¸€ä¸ªæ™®é€šç”¨æˆ·çš„æƒé™åšåˆ°ä»¥ä¸‹äº‹æƒ…ï¼š

- åˆ›å»ºå¹¶è¿è¡Œå®¹å™¨
- é…ç½® cgroup æ¥é™åˆ¶å®¹å™¨çš„èµ„æºå ç”¨
- å®¹å™¨ç»“æŸåè¯»å– cgroup æ–‡ä»¶è·å¾—å„ç§å ç”¨æ•°æ®

æ„Ÿå…´è¶£çš„è¯»è€…å¯ä»¥å‚è€ƒç¬”è€…çš„é¡¹ç›® [Seele](https://github.com/darkyzhou/seele/tree/main/src/cgroup) ä¸­çš„å®ç°ï¼Œå®ƒåšçš„äº‹æƒ…å’Œä¸Šé¢ç±»ä¼¼ï¼ŒåŒæ ·æ˜¯å…ˆå°†å½“å‰è¿›ç¨‹ç§»åŠ¨åˆ° `app.scope` ä¸­ã€‚ä¸è¿‡ï¼Œå®ƒè¿˜é¢å¤–å°†è¿›ç¨‹çš„æ‰€æœ‰çº¿ç¨‹åˆ†é…åˆ°äº† `app.scope` ä¸‹çš„ä¸åŒå­ cgroup ä¸­ï¼Œç”¨ä»¥é…ç½® cpu controller è¿›è¡Œç»‘æ ¸ã€‚è€Œè¿›ç¨‹åˆ›å»ºçš„ `container.slice` çš„è·¯å¾„åˆ™ä¼šè¢«ä¼ ç»™ runjï¼ˆç¬”è€…åŒ…è£…çš„ runcï¼‰ï¼Œç”¨æ¥ç®¡ç†åˆ›å»ºå®¹å™¨çš„å„ç§èµ„æºã€‚
